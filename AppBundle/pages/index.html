<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <!--    Scripts loading  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <!--    Links for functionnality  -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!--    Custom style sheets  -->
    <link rel="stylesheet" type="text/css" href="../ressources/css/main.css">
    <link rel="stylesheet" type="text/css" href="../ressources/css/index.css">
</head>

<body>
    <header>
        <div class="logo">
            <img src="../ressources/assets/images/webflix_orig.png">
        </div>
        <button class="adminSection" style="visibility: hidden">admin</button>
        <button class="profileBubble">
            <img id="profilePicture"
                 src="../ressources/assets/images/defaultUserProfile.png"
                 alt="../ressources/assets/images/defaultUserProfile.png">
        </button>
        <button class="webflixhelp">
            <img src="../ressources/assets/images/help.png"
                 alt="../ressources/assets/images/help.png"
                 style="display: block;border-radius: 50%" color= "white" width="40px" height="40px">
        </button>
    </header>

    <section id="starringShow">
        <img src="https://collider.com/wp-content/uploads/inception_movie_poster_banner_04.jpg" alt="">
    </section>
    <section id="categoryList"></section>
</body>
<script src="../ressources/javascript/mainJavaScript.js"></script>
<script>
    let nbrButtons = 0, nbrIntervals = 0;

    checkConnection();
    if (sessionStorage.getItem("adminAccount") === "1") {
        $(".adminSection").css("visibility", "visible");
    }

    $(document).ready(function(){

        if (sessionStorage.getItem("profile") !== null && sessionStorage.getItem("profile") !== "") {
            let profilepic = sessionStorage.getItem("profile");
            result = profilepic.split("/../");
            if (result.length > 1){
                sessionStorage.setItem("profile", result[1]);
            }
            $("#profilePicture").attr("src", "../" + sessionStorage.getItem("profile"));
        }

        getGenres();

        $(".profileBubble").click(function() {
            window.open("account/myAccount.html", "_self");
        });

        $(".webflixhelp").click(function() {
            window.open("aide/tutorialWebflix.html", "_self");
        });

        $(window).scroll(function() {
            $('header').css("background-color", 'rgba(17, 17, 17, ' + (0.3 + (0.7 * $(window).scrollTop() / 200)) + ')');
        });



        $(".adminSection").click(function() {
            window.open("admin/adminMenu.html", "_self");
        });

        $(document).on('click', '#idCreerProfil', function() {
            $("#idVideo").html("<video id='idVideo' width='1000' height='500' controls autoplay>");
            $("#idSource").html("<source id='idSource' src='' type='video/mp4'></video>");
        });

    });


    var checkExist = setInterval(function() {
        if ($('.left').length > nbrButtons) {
            nbrButtons = $('.left').length;
            $(".right").click(function() {
                $(this).parent().parent().stop().animate({scrollLeft: "+=750"}, 800);
            });
            $(".left").click(function() {
                $(this).parent().parent().stop().animate({scrollLeft: "-=750"}, 800);
            });
        } else {
            nbrIntervals ++;
            if (nbrIntervals >= 10){
                clearInterval(checkExist);
            }
        }
    }, 100); // check every 100ms



    $(document).on("click", ".favStar-active", function(event) {
        $(this).addClass("favStar-non-active");
        $(this).removeClass("favStar-active");
        let classes = $(this).parent().parent().attr("class");
        var idCard = classes.split(" ");
        let postForm2 = {
            'email': sessionStorage.getItem("emailAccount"),
            'idCard': idCard[1]
        }
        $.ajax({
            //Process the form using $.ajax()
            type: 'POST', //Method type
            url: '../management/deleteFavorite.php', //Your form processing file URL
            data: postForm2, //Forms name
            dataType: 'JSON',
            success: function(data) {

            },
            error: function(erreur, message) {
                console.log(erreur, message);
            }
        });
        window.open("index.html", "_self");
    });

    $(document).on("click", ".favStar-non-active", function(event) {
        $(this).addClass("favStar-active");
        $(this).removeClass("favStar-non-active");
        let classes = $(this).parent().parent().attr("class");
        var idCard = classes.split(" ");
        let postForm1 = {
            'email': sessionStorage.getItem("emailAccount"),
            'idCard': idCard[1]
        }
        $.ajax({
            //Process the form using $.ajax()
            type: 'POST', //Method type
            url: '../management/addFavorite.php', //Your form processing file URL
            data: postForm1, //Forms name
            dataType: 'JSON',
            success: function(data) {

            },
            error: function(erreur, message) {
                console.log(erreur, message);
            }
        });
        window.open("index.html", "_self");
    });

    function getGenres() {
        let listeGenres = [];
        $.ajax({
            //Process the form using $.ajax()
            type: 'POST', //Method type
            url: '../management/getGenresFromCards.php', //Your form processing file URL
            dataType: 'JSON',
            success: async function(data) {
                let currGenres;
                for (ctr = 0; ctr < data.length; ctr++) {
                    currGenres = JSON.parse(data[ctr][0]);

                    for (ctrGenres = 0; ctrGenres < currGenres.length; ctrGenres++) {
                        if ($.inArray(currGenres[ctrGenres], listeGenres) === -1) {
                            listeGenres.push(currGenres[ctrGenres]);
                        }
                    }
                }
                getVideosByGenre(listeGenres);
            },
            error: function(erreur, message) {
                console.log(erreur, message);
            }
        });
    }

    function getVideosByGenre(listeGenres) {
        for (ctr = 0; ctr < listeGenres.length; ctr++) {
            let ctrAjax = ctr;
            $.ajax({
                //Process the form using $.ajax()
                type: 'POST', //Method type
                url: '../management/getVideosByGenre.php', //Your form processing file URL
                data: {
                    'genre': listeGenres[ctrAjax],
                    'email': sessionStorage.getItem("emailAccount")
                },
                dataType: 'JSON',
                success: function(data) {
                    let Desc;
                    // header de categorie
                    $("#categoryList").append('<h4 class="catTitle">' + listeGenres[ctrAjax] + '</h4>' +
                        '<hr><div class="category" id="' + listeGenres[ctrAjax] + '""></div>');
                    // debut de la liste et fleche de gauche
                    $("#" + listeGenres[ctrAjax]).append('<ul class="videoList"><div class="left">' +
                        '<i class="material-icons md-36">arrow_back_ios</i></div></ul>');
                    // cards de la liste
                    for (ctrVid = 0; ctrVid < data.length; ctrVid++) {
                        if (data[ctrVid].Resume.length >= 100){
                                Desc = data[ctrVid].Resume.substr(0, 100) + "...";
                            } else {
                                Desc = data[ctrVid].Resume + "";
                            }
                        if (data[ctrVid][11] != 0) {
                            $("#" + listeGenres[ctrAjax] + "> .videoList").append(`
                                <div onclick = "Details('${data[ctrVid].File}', '${data[ctrVid][0]}')" class="card ${data[ctrVid][0]}">
                                <img src="${data[ctrVid].Image}" class="card-img">
                                <div class="card-body">
                                <h5 class="card-title" id="card1Title">${data[ctrVid].Title}</h5>
                                <i class="material-icons favStar-active">star</i>
                                <p class="card-text">${Desc}</p>
                                </div>
                                </div>`);
                        } else {
                            $("#" + listeGenres[ctrAjax] + "> .videoList").append(`
                                <div onclick = "Details('${data[ctrVid].File}', '${data[ctrVid][0]}')" class="card ${data[ctrVid][0]}">
                                <img src="${data[ctrVid].Image}" class="card-img">
                                <div class="card-body">
                                <h5 class="card-title" id="card1Title">${data[ctrVid].Title}</h5>
                                <i class="material-icons favStar-non-active">star</i>
                                <p class="card-text">${Desc}</p>
                                </div>
                                </div>`);
                        }
                    }
                    // fleche de droite et fin de la liste
                    $("#" + listeGenres[ctrAjax] + "> .videoList")
                        .append('<div class="right"><i class="material-icons md-36">arrow_forward_ios</i></div><hr>');
                },
                error: function(erreur, message) {
                    console.log(erreur, message);
                }
            });
        }
    }



    function Details(file, ID) {
        sessionStorage.setItem("VideoPath", file);
        sessionStorage.setItem("idCard", ID);
        window.open("video.html", "_self");
    }

</script>

</html>