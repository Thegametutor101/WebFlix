<!DOCTYPE html>
<htmL>

<head>
    <title>Webflix - Changer le mot de passe</title>
    <meta charset="utf-8">
    <!--    Scripts loading  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!--    Links for functionnality  -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--    Custom style sheets  -->
    <link rel="stylesheet" type="text/css" href="../../../ressources/css/main.css">
    <link rel="stylesheet" type="text/css" href="../../../ressources/css/account.css">
</head>

<body>
    <div class="main">
        <div class="header">
            <div id="logo">
                <span class="material-icons" id="back">arrow_back_ios</span>
                <img src="https://canniefish.weebly.com/uploads/1/1/8/3/118361953/webflix_orig.png" alt="Webflix" width="350px" height="150px">
            </div>
        </div>
        <div class="manage">
            <h2 style="border-bottom: #111111">Modification du mot de passe</h2>
        </div>
        <hr><br><br>
        <div class="messages"></div>
        <div class="content">
            <div id="edit_top">
                <div id="edit_left">
                    <h3>Ancien mot de passe</h3>
                    <h3>Nouveau mot de passe</h3>
                    <h3>Confirmer mot de passe</h3>
                    <h3>Confirmer le changement</h3>
                </div>
                <div id="edit_right">
                    <input id="oldPassword" type="password" value="*********" disabled readonly><br>
                    <input id="newPassword" type="password" maxlength="250"><br>
                    <input id="confirmNewPassword" type="password" maxlength="250"><br>
                    <input id="confirmUpdate" type="password" maxlength="250">
                </div>
            </div>
            <div id="edit_bottom">
                <button class="confirmButtons" id="confirm" type="button">Confirmer</button>
                <button class="confirmButtons" id="cancel" type="button">Annuler</button>
            </div>
        </div>
    </div>
</body>
<script>
    let pwd = sessionStorage.getItem("passwordAccount");
    $("#newPassword").focus();
    $(document).ready(function(e) {
        $("#back").click(function(e) {
            window.open("../myAccount.html", "_self");
        });
        $("#confirm").click(function(e) {
            let messages = $(".messages");
            messages.empty();
            let email = sessionStorage.getItem("emailAccount");
            let newPassword = $("#newPassword").val().trim();
            let confirmNewPassword = $("#confirmNewPassword").val().trim();
            let confirmUpdate = $("#confirmUpdate").val().trim();
            if ((newPassword.length > 250 || newPassword.length < 8) || newPassword.length === 0) {
                messages.append("<div>Le nouveau mot de passe doit être entre 8 et 250 caractères.</div><br><hr>");
            } else if (confirmNewPassword !== newPassword) {
                messages.append("<div>Votre confirmation de mot de passe " +
                    "ne correspond pas au nouveau mot de passe.</div><br><hr>");
            } else if (confirmUpdate !== pwd) {
                messages.append("<div>L'authentification ne concorde " +
                    "pas avec votre mot de passe actuel!</div><br><hr>");
            } else {
                $.ajax({
                    url: "../../../management/updatePassword.php",
                    type: "POST",
                    data: {
                        'email': email,
                        'password': newPassword
                    },
                    dataType: "json",
                    success: function(result) {
                        let answer = result["item"];
                        if (answer === "ok") {
                            sessionStorage.setItem("passwordAccount", newPassword);
                            window.open("../myAccount.html", "_self")
                        } else if (answer === "error") {
                            messages.append("<div>Il est impossible de compléter " +
                                "votre requête présentement.<br>Veuillez réessayer plus tard.</div><br><hr>");
                        } else if (answer === "empty") {
                            messages.append("<div>Veuillez remplir les champs pour soumettre.</div><br><hr>");
                        } else {
                            messages.append("<div>Il est impossible de compléter " +
                                "votre requête présentement.<br>Veuillez réessayer plus tard.</div><br><hr>");
                        }
                    },
                    error: function(message, error) {
                        messages.append("<div>Erreur lors de votre requête. " +
                            "Veuillez réessayer plus tard.</div><br><hr>");
                        console.log(message, error);
                    }
                });
            }
        });
        $("#cancel").click(function() {
            window.open("../myAccount.html", "_self");
        });
    });
</script>
<style>
    #logo {
        display: flex;
        flex-direction: row;
    }
    
    #back {
        cursor: pointer;
        width: 30px;
        vertical-align: center;
        text-align: center;
        margin: auto
    }
    
    #back:hover {
        transform: scale(1.2);
    }
    
    #back:active {
        transform: scale(0.98);
    }
</style>

</htmL>