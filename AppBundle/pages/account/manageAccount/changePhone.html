<!DOCTYPE html>
<htmL>

<head>
    <title>Webflix - Changer le numero de telephone</title>
    <meta charset="utf-8">
    <!--    Scripts loading  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!--    Links for functionnality  -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--    Custom style sheets  -->
    <link rel="stylesheet" type="text/css" href="../../../ressources/css/main.css">
    <link rel="stylesheet" type="text/css" href="../../../ressources/css/account.css">
</head>

<body>
    <div class="main">
        <div class="header">
            <div id="logo">
                <span class="material-icons" id="back">arrow_back_ios</span>
                <img src="https://canniefish.weebly.com/uploads/1/1/8/3/118361953/webflix_orig.png" alt="Webflix" width="350px" height="150px">
            </div>
        </div>
        <div class="manage">
            <h2 style="border-bottom: #111111">Modification du numéro de téléphone</h2>
        </div>
        <hr><br><br>
        <div class="messages"></div>
        <div class="content">
            <div id="edit_top">
                <div id="edit_left">
                    <h3>Ancien téléphone </h3>
                    <h3>Nouveau téléphone </h3>
                    <h3>Confirmer telephone </h3>
                    <h3>Confirmer le changement</h3>
                </div>
                <div id="edit_right">
                    <input id="oldPhone" type="text" value="BroadestOdinDev" disabled readonly><br>
                    <input id="newPhone" type="tel" placeholder="8199998888" maxlength="18" minlength="10"><br>
                    <input id="confirmNewPhone" type="tel" placeholder="8199998888" maxlength="18" minlength="10"><br>
                    <input id="confirmUpdate" type="password" placeholder="Entrez votre mot de passe" maxlength="250">
                </div>
            </div>
            <div id="edit_bottom">
                <button class="confirmButtons" id="confirm" type="button">Confirmer</button>
                <button class="confirmButtons" id="cancel" type="button">Annuler</button>
            </div>
        </div>
    </div>
</body>
<script>
    let pwd = sessionStorage.getItem("passwordAccount");
    $("#oldPhone").val(sessionStorage.getItem("phoneAccount"));
    $("#newPhone").focus();
    $(document).ready(function(e) {
        $("#back").click(function(e) {
            window.open("../myAccount.html", "_self");
        });
        let email = sessionStorage.getItem("emailAccount");
        $("#confirm").click(function(e) {
            let messages = $(".messages");
            messages.empty();
            $("#newPhone").val().trim().replace(/\D/g, '');
            $("#confirmNewPhone").val().trim().replace(/\D/g, '');
            let oldPhone = $("#oldPhone").val().trim();
            let newPhone = $("#newPhone").val().trim();
            let confirmNewPhone = $("#confirmNewPhone").val().trim();
            let confirmUpdate = $("#confirmUpdate").val().trim();
            if (newPhone.length > 18 || newPhone.length === 0) {
                messages.append("<div>Veuillez entrer un nouveau " +
                    "téléphone n'excédant pas 18 caractères.</div><br><hr>");
            } else if (!newPhone.match(/\d{10}/g)) {
                messages.append("<div>Veuillez entrer un numéro " +
                    "de téléphone valide.</div><br><hr>");
            } else if (newPhone === oldPhone) {
                messages.append("<div>Le nouveau telephone ne peut " +
                    "pas etre identique a l'ancien telephone.</div><br><hr>");
            } else if (newPhone !== confirmNewPhone) {
                messages.append("<div>La confirmation du téléphone " +
                    "ne correspond pas au nouveau téléphone.</div><br><hr>");
            } else if (confirmUpdate !== pwd) {
                messages.append("<div>Le champ confirmer la modification " +
                    "ne concorde pas avec votre mot de passe!</div><br><hr>");
            } else {
                newPhone = "(" + newPhone.substr(0, 3) + ") " +
                    newPhone.substr(3, 3) + "-" + newPhone.substr(6, 4);
                $.ajax({
                    url: "../../../management/updatePhone.php",
                    type: "POST",
                    data: {
                        'email': email,
                        'phone': newPhone
                    },
                    dataType: "json",
                    success: function(result) {
                        let answer = result["item"];
                        if (answer === "ok") {
                            sessionStorage.setItem("phoneAccount", newPhone);
                            window.open("../myAccount.html", "_self");
                        } else if (answer === "error") {
                            messages.append("<div>Il est impossible de compléter " +
                                "votre requête présentement.<br>Veuillez réessayer plus tard.</div><br><hr>");
                        } else if (answer === "empty") {
                            messages.append("<div>Veuillez remplir les champs pour soumettre.</div><br><hr>");
                        } else {
                            messages.append("<div>Il est impossible de compléter " +
                                "votre requête présentement.<br>Veuillez réessayer plus tard.</div><br><hr>");
                        }
                    },
                    error: function(message, error) {
                        messages.append("<div>Erreur lors de votre requête. " +
                            "Veuillez réessayer plus tard.</div><br><hr>");
                        console.log(message, error);
                    }
                });
            }
        });
        $("#cancel").click(function() {
            window.open("../myAccount.html", "_self");
        });
    });
</script>
<style>
    #logo {
        display: flex;
        flex-direction: row;
    }
    
    #back {
        cursor: pointer;
        width: 30px;
        vertical-align: center;
        text-align: center;
        margin: auto
    }
    
    #back:hover {
        transform: scale(1.2);
    }
    
    #back:active {
        transform: scale(0.98);
    }
</style>

</htmL>